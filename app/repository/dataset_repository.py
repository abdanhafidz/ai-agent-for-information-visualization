from contextlib import AbstractContextManager
from typing import Callable
from sqlalchemy.orm import Session
from app.model.dataset import Dataset
from app.repository.base_repository import BaseRepository
import pandas as pd

class DatasetRepository(BaseRepository):
    def __init__(self, session_factory: Callable[..., AbstractContextManager[Session]]):
        super().__init__(session_factory, Dataset)

    def create_table_from_df(self, df: pd.DataFrame, table_name: str):
        with self.session_factory() as session:
            engine = session.get_bind()
            df.to_sql(table_name, con=engine, if_exists='fail', index=False)

    def get_preview(self, table_name: str, limit: int = 20):
        from sqlalchemy import text
        with self.session_factory() as session:
            try:
                # Safe parameterized query? Table names can't be parameterized in standard SQL easily without risk,
                # but these table names are generated by us (sanitized).
                # We will use text() and string formatting carefully or just query execution.
                result = session.execute(text(f"SELECT * FROM {table_name} LIMIT :limit"), {"limit": limit})
                keys = result.keys()
                return [dict(zip(keys, row)) for row in result.fetchall()]
            except Exception as e:
                print(f"Error getting preview: {e}")
                return []
